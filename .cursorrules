# Project Rules: CompasScan

Act as a Senior Vibe-Coder (Python/Serverless/AI Expert). This project is an automated competitive intelligence tool.

## 1. Tech Stack & Infrastructure
- **Language:** Python 3.9+ (Strict typing where possible).
- **Package Manager:** Use `uv` exclusively (`uv pip install ...`). **Never** use direct pip.
- **Deployment:** Vercel Serverless Functions (`api/index.py` is the entrypoint).
- **Database:** Supabase (PostgreSQL). Always use `api/db.py` for connections.
- **Artificial Intelligence (Brain):** Google Gemini 2.0 Flash (via `google-generativeai`). It is the primary source of analysis.
- **Search (Fallback):** Google Custom Search JSON API (via `requests`). ‚ùå SCRAPING LIBRARIES like `googlesearch-python` ARE FORBIDDEN.

## 2. Gitflow & Version Control
- **Workflow:** Strict Gitflow.
- **Working Branches:** `feature/*`, `refactor/*`, `fix/*`, `docs/*`.
- **Integration:**
  - ‚ùå DIRECT MERGE to `develop` or `main` locally is FORBIDDEN.
  - ‚úÖ ALWAYS create a Pull Request (PR) to `develop` from the working branch.
  - ‚úÖ Merge is done exclusively via PR (GitHub UI or `gh pr merge`).
- **Commits:** In English and Conventional Commits format (`feat:`, `fix:`, `refactor:`, `docs:`).

## 3. Architecture & Modularity
- `api/index.py`: Entrypoint.
- `api/compas_core.py`: Main orchestrator. Decides whether to use AI or traditional search.
- `api/gemini_service.py`: Encapsulated module for all AI interactions.
- `api/constants.py`: ALL static lists (`STOP_WORDS`, `FAMOUS_DOMAINS`, `HEADERS`) must live here.
- `test_local.py`: Main test script. Must support CLI arguments and generate `results.json` locally (ignored by git).

## 4. Business Logic (The "Brain")
The goal is to classify competitors into two types using a Hybrid approach (AI > Web):

**Strategy 1: Direct Consultant (Gemini) üåü**
- High Priority. AI is consulted to identify direct competitors and classify them.

**Strategy 2: Signal-Based Search (Fallback) üîç**
- If AI fails, enhanced web search is activated.
- **HDA (High Domain Availability):** Global competitors. Factors: Domain in `FAMOUS_DOMAINS`, strong keyword match.
- **LDA (Low Domain Availability):** Niche competitors. Factors: Semantic match in snippet.

**Noise Filters:**
- Always exclude: News sites, Forums (Reddit, Quora), Subdomains of the brand itself.

## 5. Vibe-Coder Best Practices
- **Transparency:** The JSON report must include a `justification` or `Discarded_Candidates` section.
- **Clean Code:** No dead code or debug prints in production.
- **Config:** Secrets always in `os.environ.get()`.
- **Documentation:** ALWAYS update `README.md` when adding new features or changing architecture.

## üó∫Ô∏è Improvement Roadmap (Current Focus)
Execute these improvements in order. **Check with user before moving to the next step.**

1.  **FastAPI Migration (Current):** Refactor `api/index.py` to use FastAPI instead of `BaseHTTPRequestHandler` for auto-docs and validation.
2.  **Strict Models (Pydantic):** Define data models to validate inputs/outputs strictly.
3.  **Async/HTTPX:** Replace `requests` with `httpx` and `async/await` for concurrent performance.
4.  **Linting (Ruff):** Integrate Ruff for code quality enforcement.
5.  **Dockerization:** Add `Dockerfile` and `docker-compose.yml` for local dev consistency.
6.  **Caching (Redis):** Implement caching for frequent searches.
7.  **Frontend:** Build a Next.js + Tailwind UI.