# Project Rules: CompasScan

Act as a Senior Vibe-Coder (Python/Serverless/AI Expert). This project is an automated competitive intelligence tool.

## 1. Tech Stack & Infrastructure
- **Language:** Python 3.9+ (Strict typing where possible).
- **Package Managers:**
  - Backend (Python): Use **`uv`** exclusively (`uv pip install ...`). **Never** use pip directly.
  - Frontend (JS/TS): Use **`bun`** exclusively (`bun install`, `bun run dev`).
- **Deployment:** Vercel Serverless Functions (`api/index.py` is the entrypoint).
- **Database:** Supabase (PostgreSQL). Always use `api/db.py` for connections.
- **Artificial Intelligence (Brain):** Google Gemini 2.0 Flash (via `google-generativeai`). It is the primary source of analysis.
- **Search (Fallback):** Google Custom Search JSON API (via `requests`). ‚ùå SCRAPING LIBRARIES like `googlesearch-python` ARE FORBIDDEN.

## 2. Gitflow & Version Control
- **Workflow:** Strict Gitflow with 3-tier deployment.
- **Branch Structure:**
  - `main` - Production (https://compas-scan.vercel.app)
  - `staging` - Pre-production/QA (https://compas-scan-staging.vercel.app)
  - `develop` - Development (https://compas-scan-dev.vercel.app)
  - `feature/*`, `refactor/*`, `fix/*`, `docs/*` - Working branches
- **Integration Flow:**
  - ‚ùå DIRECT MERGE to `develop`, `staging`, or `main` locally is FORBIDDEN.
  - ‚úÖ ALWAYS create a Pull Request (PR) from working branch.
  - ‚úÖ Flow: `feature/*` ‚Üí `develop` ‚Üí `staging` ‚Üí `main`
  - ‚úÖ **ALL promotions require PRs:**
    - `feature/*` ‚Üí `develop` (via PR)
    - `develop` ‚Üí `staging` (via PR)
    - `staging` ‚Üí `main` (via PR)
  - ‚úÖ Merge is done exclusively via PR (GitHub UI or `gh pr merge`).
- **Promotion Strategy:**
  - `develop`: Continuous integration (auto-deploy on merge)
  - `staging`: Weekly releases for QA testing
  - `main`: Production releases (after staging approval)
- **Commits:** In English and Conventional Commits format (`feat:`, `fix:`, `refactor:`, `docs:`).

## 3. Architecture & Modularity
- `api/index.py`: Entrypoint.
- `api/compas_core.py`: Main orchestrator. Decides whether to use AI or traditional search.
- `api/gemini_service.py`: Encapsulated module for all AI interactions.
- `api/constants.py`: ALL static lists (`STOP_WORDS`, `FAMOUS_DOMAINS`, `HEADERS`) must live here.
- `tests/test_local.py`: Main test script. Must support CLI arguments and generate `results.json` locally (ignored by git).

## 4. Business Logic (The "Brain")
The goal is to classify competitors into two types using a Hybrid approach (AI > Web):

**Strategy 1: Direct Consultant (Gemini) üåü**
- High Priority. AI is consulted to identify direct competitors and classify them.

**Strategy 2: Signal-Based Search (Fallback) üîç**
- If AI fails, enhanced web search is activated.
- **HDA (High Domain Availability):** Global competitors. Factors: Domain in `FAMOUS_DOMAINS`, strong keyword match.
- **LDA (Low Domain Availability):** Niche competitors. Factors: Semantic match in snippet.

**Noise Filters:**
- Always exclude: News sites, Forums (Reddit, Quora), Subdomains of the brand itself.

## 5. Vibe-Coder Best Practices
- **Transparency:** The JSON report must include a `justification` or `Discarded_Candidates` section.
- **Clean Code:** No dead code or debug prints in production.
- **Config:** Secrets always in `os.environ.get()`.
- **Documentation:** ALWAYS update `README.md` when adding new features or changing architecture.

## 6. Agent Protocol (MANDATORY) üõ°Ô∏è
Before writing code or applying fixes, you MUST follow this sequence:

1.  **Check Branch:** Verify current branch. If on `main`, `staging`, or `develop`, STOP and create a new branch.
2.  **Create Branch:** For any change, generate a command to create a specific branch:
    - New Feature -> `feature/name`
    - Bug Fix -> `fix/name`
    - Refactor -> `refactor/name`
3.  **Apply Changes:** Write the code only after the branch is active.
4.  **Test:** Run `uv run python tests/test_local.py "Brand"` to verify.
5.  **üìù UPDATE ROADMAP:** If completing a Roadmap item, update `.cursorrules` to mark it as `[Done]` and move `(Current)` to the next item BEFORE committing.
6.  **Commit & Push:** Generate standard git commands (include .cursorrules if roadmap was updated).
7.  **Create PR:** 
    - For working branches ‚Üí `develop`: `gh pr create --base develop ...`
    - For `develop` ‚Üí `staging`: `gh pr create --base staging ...`
    - For `staging` ‚Üí `main`: `gh pr create --base main ...`
8.  **‚úã STOP & ASK:** Do NOT merge automatically. Ask the user: *"PR created. Ready to merge?"*. Only proceed if confirmed.

## üó∫Ô∏è Improvement Roadmap (Current Focus)
Execute these improvements in order. **Check with user before moving to the next step.**

1.  [Done] FastAPI Migration.
2.  [Done] Strict Models (Pydantic).
3.  [Done] Async/HTTPX.
4.  [Done] Linting (Ruff).
5.  [Done] Dockerization.
6.  [Done] Caching (Redis).
6.5 [Done] Observability & MCP Integration (Logfire + Sentry + Brave Search).
7.  [Done] Frontend: Build a Next.js + Tailwind UI (Using **Bun** as package manager).
8.  [Done] Code Quality & Refactoring: Refactor `run_compas_scan()` and improve code maintainability.
9.  [Done] Geo-Awareness: Implement TLD-based geographic detection and local competitor prioritization (60+ countries).
10. [Done] Project Organization: Consolidate documentation and clean up project structure.
11. **(Current)** Production Readiness: Promote to staging, validate, and prepare for production deployment.